name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_confirmation:
        description: 'Skip deployment confirmation'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        
    - name: Deploy to Production
      run: |
        ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
          set -e
          cd /var/www/optimizer
          
          echo "ðŸ”„ Updating code..."
          git fetch origin
          git checkout main
          git pull origin main
          
          echo "ðŸ—ï¸ Building new Docker image with cache busting..."
          BUILD_TIMESTAMP=$(date +%s)
          GIT_COMMIT=$(git rev-parse HEAD)
          
          docker build \
              --target production \
              --build-arg BUILD_TIMESTAMP=$BUILD_TIMESTAMP \
              --build-arg CACHEBUST=$GIT_COMMIT \
              -t optimizer-app:production \
              -f docker/production/Dockerfile \
              .
          
          echo "ðŸ”§ Skipping maintenance mode (can cause hangs)..."
          
          echo "ðŸš€ Deploying new containers..."
          docker compose -f docker-compose.prod.yml up -d --no-deps app
          echo "âœ… Container deployment completed"
          
          echo "ðŸ“¦ Running Laravel maintenance tasks..."
          docker compose -f docker-compose.prod.yml exec -T app php artisan migrate --force
          docker compose -f docker-compose.prod.yml exec -T app php artisan optimize:clear
          docker compose -f docker-compose.prod.yml exec -T app php artisan config:cache
          docker compose -f docker-compose.prod.yml exec -T app php artisan route:cache
          docker compose -f docker-compose.prod.yml exec -T app php artisan view:cache
          
          echo "âœ… Disabling maintenance mode..."
          docker compose -f docker-compose.prod.yml exec -T app php artisan up
          
          echo "ðŸ” Verifying deployment..."
          docker compose -f docker-compose.prod.yml ps
          
          echo "ðŸŒ Testing application..."
          docker compose -f docker-compose.prod.yml exec -T app curl -f -s -I http://localhost && echo "âœ… Local test passed"
          
          echo "ðŸŒ Testing external access..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://img-optim.xtemos.com/)
          echo "External response: HTTP $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… External test passed"
          else
            echo "âš ï¸ External test returned HTTP $HTTP_CODE"
            exit 1
          fi
          
          echo "âœ… Deployment completed successfully!"
        ENDSSH
        
    - name: Deployment Summary
      run: |
        echo "ðŸŽ‰ Production deployment completed!"
        echo "ðŸŒ Application URL: https://img-optim.xtemos.com"
        echo "ðŸ“ Commit: ${{ github.sha }}"
        echo "ðŸ‘¤ Deployed by: ${{ github.actor }}" 